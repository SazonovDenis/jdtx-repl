### Устранение дубликатов в справочниках


##### Суть проблемы

Работа в распределенных базах благоприятствует возникновению дублирующихся записей,
чаще всего в справочниках. За ними нужно постоянно ухаживать - убирать лишние или дублирующиеся значения.


##### Объединение записей

Готовится задание на слияние (на любой рабочей станции, но лучше на центральной): 
в таблице-справочнике выбираем несколько записей (лишних), назначаем им запись-замену, из этой же таблицы. 
Получается команда "вот эти записи по списку - удалить, вместо них использовать вот эту новую запись".

В задании на слияние "эталонная" запись должна быть именно ВСТАВЛЕНА как новая, а не выбранной из уже существующих, 
т.к. при поступлении команды на рабочую станцию на ней может НЕ ОКАЗАТЬСЯ той записи, которую назначили как "эталонная" 
(из-за фильрации записей или по историческим причинам - например: уже удалили раньше сами).

Далее можно:


##### 1. Объединение прямо на станции

Выполнить это задание прямо на той же станции: произойдет реальный айпейт всех ссылок и реальное удаление одинаковых записей,
и это изменение в виде потока обычных реплик поступит в общую очередь. Если выполнять на центральной базе, и в этой базе есть ВСЕ записи, 
то тогда можно действительно избавиться от ссылок на удаляемые записи.

Недостатки: 

- слияние записей на центральной базе может породить большой объем КАСКАДНЫХ изменений
- пока изменения будут выполняться, помещаться в очередь и рассылаться по рабочим станциям, 
  на самих рабочх станциях могут ДОПОЛНИТЕЛЬНО добавить записи, ссылающиеся на записи, на СЕРВЕРЕ уже удаленные. 
  Это приведет либо к поломке приема "объединяющих реплик" с сервера, либо к массовому отказу 
  в удалении и обратной вставке записей, удаленных на сервере. 


##### 2. Специальная команда "объедини записи"

Реализация через отсылку в очередь реплик специальной команды для рабочей станции "объедини записи" 
("MERGE" - дополнительная к набору IDE, SNAPSHOT).
Преимущества: малый объем реплик с сервера и полная безопасность в плане ссылочной целостности. 
Важно учесть, что на рабочей станции может НЕ ОКАЗАТЬСЯ той записи, которую назначили как "эталонная", 
поэтому ОБЯЗАТЕЛЬНОЙ частью команды "объедини записи" должна быть НОВАЯ эталонная запись, которая ЗАРАНЕЕ вставляется,
перед отправкой команды "MERGE" в очередь и вставляется ИГНОРИРУЯ правила фильрации.

Чтобы не столкнутся с ситуацией "рабочая станция уже удалилла ненужные записи, 
а тут пришли древние реплики от отстающнго филиала с использованием УЖЕ УДАЛЕННЫХ записей" нужно:

- подать всем станциям команду "MUTE"
- дождаться, пока: 
  - все станции замолчат 
  - все станции получат и обработают все остаточные реплики (т.е. счетчик "обработано" станет одинаково).
- отправить команду MERGE в систему 
- подать всем станциям команду "UNMUTE", причем можно сразу после MERGE, не дожидаясь результатов, 
  т.к. в любом случае "UNMUTE" будет выполнена после "MERGE" и в систему удаляемые записи не попадут.  


## Руководство пользователя по удалению дубликатов

##### Формирование плана слияния

- На сервере выполняется команда `jc rec-merge-find`.
  Получившийся файл "*.plan.json" при необходимости исправляется вручную.


##### Выполнение плана слияния

- Переход в "режим молчания".
  На сервере выполняется команда `jc repl-mute`.
- Ожидание, что все станции перешли в "режим молчания".
  На сервере проверяется команда `jc repl-dbstruct-state -wait`.
- Ожидание, что все станции все станции обработают все остаточные реплики.
- Отправка команды "MERGE" на филиалы.
  На сервере выполняется команда `jc repl-merge-request`.
- Отключение "режима молчания".
  На сервере выполняется команда `jc repl-unmute`.
