### Устранение дубликатов в справочниках


##### Суть проблемы

Работа в распределенных базах благоприятствует возникновению дублирующихся записей,
чаще всего в справочниках. За ними нужно постоянно ухаживать - убирать лишние или дублирующиеся значения.


##### Объединение записей

Готовится задание на слияние (на любой рабочей станции, но лучше на центральной): 
в таблице-справочнике выбираем несколько записей (лишних), назначаем им запись-замену, из этой же таблицы. 
Получается команда "вот эти записи по списку - удалить, вместо них использовать вот эту новую запись".

В задании на слияние "эталонная" запись должна быть именно ВСТАВЛЕНА как новая, а не выбранной из уже существующих, 
т.к. при поступлении команды на рабочую станцию на ней может НЕ ОКАЗАТЬСЯ той записи, которую назначили как "эталонная" 
(из-за фильрации записей или по историческим причинам - например: уже удалили раньше сами).

Далее можно:


##### 1. Объединение прямо на станции

Выполнить это задание прямо на той же станции: произойдет реальный айпейт всех ссылок и реальное удаление одинаковых записей,
и это изменение в виде потока обычных реплик поступит в общую очередь. Если выполнять на центральной базе, и в этой базе есть ВСЕ записи, 
то тогда можно действительно избавиться от ссылок на удаляемые записи.

Недостатки: 

- слияние записей на центральной базе может породить большой объем КАСКАДНЫХ изменений
- пока изменения будут выполняться, помещаться в очередь и рассылаться по рабочим станциям, 
  на самих рабочх станциях могут ДОПОЛНИТЕЛЬНО добавить записи, ссылающиеся на записи, на СЕРВЕРЕ уже удаленные. 
  Это приведет либо к поломке приема "объединяющих реплик" с сервера, либо к массовому отказу 
  в удалении и обратной вставке записей, удаленных на сервере. 


##### 2. Специальная команда "объедини записи"

Реализация через отсылку в очередь реплик специальной команды для рабочей станции "объедини записи" 
("MERGE" - дополнительная к набору IDE, SNAPSHOT).
Преимущества: малый объем реплик с сервера и полная безопасность в плане ссылочной целостности. 
Важно учесть, что на рабочей станции может НЕ ОКАЗАТЬСЯ той записи, которую назначили как "эталонная", 
поэтому ОБЯЗАТЕЛЬНОЙ частью команды "объедини записи" должна быть НОВАЯ эталонная запись, которая ЗАРАНЕЕ вставляется,
перед отправкой команды "MERGE" в очередь и вставляется ИГНОРИРУЯ правила фильрации.

Чтобы не столкнутся с ситуацией "рабочая станция уже удалилла ненужные записи, 
а тут пришли древние реплики от отстающнго филиала с использованием УЖЕ УДАЛЕННЫХ записей" нужно:

- подать всем станциям команду "MUTE"
- дождаться, пока: 
  - все станции замолчат 
  - все станции получат и обработают все остаточные реплики (т.е. счетчик "обработано" станет одинаково).
- отправить команду MERGE в систему 
- подать всем станциям команду "UNMUTE", причем можно сразу после MERGE, не дожидаясь результатов, 
  т.к. в любом случае "UNMUTE" будет выполнена после "MERGE" и в систему удаляемые записи не попадут.  


###### Важно!

Следует учесть, что если на станцию отправить сразу две команды слияния для двух таблиц, от которых, зависит третья
(напр. Lic -> LicDocTip и Lic -> Ulz), то возможна ситуация, когда результат применения первого слияния 
(напр. изменения в Lic после слияния в LicDocTip), оформленный как реплика, будет иметь такие ссылки на вторую таблицу 
(напр. Lic -> Ulz), которые станут недействительными после слияния во второй таблице (Ulz) 

1. В таблице Lic есть ссылки на справочники LicDocTip и Ulz (Lic -> LicDocTip и Lic -> Ulz). 
2. Станция получает команду на слияние в справочники LicDocTip и Ulz 
3. Станция выполняет команду на слияние в справочнике LicDocTip
4. Процес по каким-то причинам прерывается
5. Процес запускается снова
6. Станция начинает формирование и отправку первой реплики по результатам слияния LicDocTip, 
   в этой реплике содердатся изменненые записи в Lic, со СТАРЫМИ, НЕ СЛИТЫМИ ссылками на Ulz
7. Станция выполняет команду на слияние в справочнике Ulz
8. Станция формирует и отправляет вторую реплику по результатам слияния Ulz,
   в этой реплике содержатся изменненые записи в Lic, с НОВЫМИ ссылками на СЛИТЫЕ значения в Ulz
9. Первая реплика приходит на сервер или другую станцию, которые УСПЕШНО закончили слияние в обеих таблицах LicDocTip и Ulz.
   Применение этой первой реплики невозможно из-за того, что в ней содержатся СТАРЫЕ ссылки на Ulz, которые более НЕ ДЕЙСТВИТЕЛЬНЫ.


Другой сценарий проблемы

1. В таблице Lic есть ссылка на справочник Ulz (Lic -> Ulz).
2. Станция А получает команду на слияние в справочнике Ulz
3. Станция А выполняет команду на слияние
4. Станция В еще не получила команду на слияние в справочнике Ulz 
5. Станция В добавила запись в Lic, и использовала то значение Ulz, которое было удалено в команде на слияние, 
   формирует и отправляет реплику с изменениями в Lic
3. Станция А не сможет применить и обработать эту реплику от станции В


Таким образом, сначала на филиалы следует подать команду "MUTE" и дождаться:

- все станции перешли в "режим молчания"
- все станции получат и обработают все остаточные реплики (т.е. счетчик "обработано" станет одинаково).

И только потом подавать команду на слияние. Тогда реплики будут готовится только после завершения слияния, после подачи команды UNMUTE,
и в репликах не появятся удаленные записи, потому, что таковых нет.


###### Важно!

Если одна таблица зависит от другой (напр. Usr -> UsrGrp), то прежде чем искать дубликаты в зависимой таблице (в Usr по полям "Name,UsrGrp"),
надо найти и слить дубликаты во влияющией таблице (UsrGrp). Если так не сделать, то поиск дубликатов в зависимой таблице 
может пройти не так полно, как мог бы. 

Таким образом, сначала дожидаемся окончания слияния самых "концевых" справочников, 
а только потом начинается поиск дубликатов и слияние в справочниках следующего уровня. 



## Руководство пользователя по удалению дубликатов

##### Формирование плана слияния

- На сервере выполняется команда `jc rec-merge-find`.
  Получившийся файл "*.plan.json" при необходимости исправляется вручную.


##### Выполнение плана слияния

- Переход в "режим молчания".
  На сервере выполняется команда `jc repl-mute`.
- Ожидание, что все станции перешли в "режим молчания".
  На сервере проверяется команда `jc repl-dbstruct-state -wait`.
- Ожидание, что все станции все станции обработают все остаточные реплики.
- Отправка команды "MERGE" на филиалы.
  На сервере выполняется команда `jc repl-merge-request`.
- Отключение "режима молчания".
  На сервере выполняется команда `jc repl-unmute`.


##### Заметки

Команда на слияание может быть отправлена только если 1) Все активные состояния молчат 2) Я получил Все изменения,
соответствующее максимальному возрасту состояния я молчу

Перед выполнением. Jc команд некоторых нужно останавливать службу, а после завершения запускать её

Команда на слияние может проверять запущенность сервера, падать если сервер не запущен, отправлять команду замолчать
дожидаться командой замолчать, я после чего гасит сервер, отправляет команду на слияние и команду говорить, после чего
сервер запускается

Проверить безопасность отправки команды замолчи

Переписать раздел документации по проблеме Зачем нужен режим молчания при слиянии записей, упростить пример проблемы
