## Смена структуры БД в репликационной сети

### Терминиы     

##### Структуры БД     

Со структурой БД связаны три понятия:
- Разрешенная структура
- Зафиксированная структура
- Реальная структура

"Разрешенная" структура приходит с сервера как структура БД, при которой можно принимать и публиковать реплики.
"Зафиксированная" структура запоминается в момент создания аудита.
"Реальная" структура - то что сейчас в БД.

##### Режим молчания, команды "mute-all" и "mute-done"

В процессе смене структур БД на станциях важно не допустить ситуации, когда на рабочую станцию с _новой_ структурой попадут реплики, 
сформированные в _старой_ структуре. Поскольку на любую станцию реплики попадают с задержкой, то нет такой станции, 
на которой можно начать смену структуры - есть риск, что после _обновления_ структуры БД, прилетит запоздавшая реплика, 
сделанная в _старой_ структуре БД. Чтобы исключить такую ситуацию требуется _режим молчания_, 
при котором станция отправила все свои старые реплики, а новых _не формирует_.

В "режиме молчания" станция не обрабатывает свой аудит и не формирует исходящих реплик, 
хотя продолжает копить аудит, получать и применять чужие реплики.

##### Переход в режим молчания

Команда `mute-all` (всем молчать) подается с сервера, все станци ее принимают и отвечают `mute-done`, 
сервер собирает ответы и отмечает у себя, что станции "замолчали". 

После того как от всех станций получено уведомление, что станция замолчала 
(а значит, что еще ранее пришли последние реплики в старой структуре, и других не будет)
можно начинать _фактическую смену_ структуры БД и ее _фиксацию_.

### Смена структуры БД 

##### Шаги по смена структуры по всей репликационной сети  

Команды и ответы на них рассылаются в виде реплик.

- Переход реликационной сети в "режим молчания". Команда `mute-all` подается с сервера, сигнал `mute-all` рассылается по всем станциям.  
- Станци принимают сигнал, переводят себя в "режим молчания" и отвечают `mute-done`. 
- Сервер, получив сигнал `mute-done`, отмечает у себя что рабочая станция перешла в "режим молчания".
- Ожидание, что все рабочие станции замолчали и отчитались об этом.
- Выполняется реальная смена структуры БД на сервере.
- Для сервера напрямую задаем структуру публикаций. На сервере выполняется команда `repl_set_cfg`.
- Рассылаем на рабочие станции новые правила публикаций. На сервере выполняется команда `repl_send_cfg`. 
- Фиксация изменения структуры. На сервере выполняется команда `repl-dbstruct-finish`.
  При этом текущая _фактическая_ структура БД записывается как _разрешенная_.
- Выход реликационной сети из "режима молчания". На сервере выполняется команда `unmute-all`. 
  Сервер рассылает эту структуру как "разрешенную" всем станциям командой `unmute-all`.   
- Рабочая станция, которая получила команду `unmute-all` обязана выполнить фиксацию до "разрешенной структуры".
  Если это невозможно (из-за несовпадения структур), то применение команды `unmute-all` 
  (и всех остальных входящих реплик) откладывается до завершения фиксации структуры БД на станции. 
- Выполняется реальная смена структуры БД на всех рабочих станциях. 
- После реальной смены структуры рабочая станция получает возможность выполнить команду `unmute-all`:
   - провести "фиксацию" структуры БД;
   - выйти из "режима молчания"; 
   - послать серверу сигнал `unmute-done`. 
- Сервер, получив сигнал `unmute-done`, отмечает у себя что рабочая станция вышла из "режима молчания".

###### Замечание

Очевидно, что в "режиме молчания" всей сети реальная смена структуры БД на сервере и любых рабочих станциях может выполнятся 
в любой последовательности, до или после команды `unmute-all`.

##### Фактическое изменение структуры

Фактическое изменение структуры БД производится сторонним инструментом (каким-либо приложением, вручную и т.п.), 
сам репликатор никаких манипуляций не производит.

После фактической смены структуры БД таблицы и триггера для аудита не соответствуют новой структуре БД,
поэтому требуется _фиксация структуры_.  

##### Фиксация смены структуры БД 

Чтобы гарантировать одинаковую структуру реплик по всей сети _фиксацию_ можно провести только при совпадении с "разрешенной" структурой.
Фиксация смены структуры БД может быть выполнена, когда "реальная" структура БД отличается от "зафиксированной", но совпадет с "разрешенной".
По _разнице_ между зафиксированной структурой и разрешенной структурой досоздается аудит:

1. Если в таблице измененился состав полей, то это не имеет значения (потому что аудит запоминает только по id измененных записей);
2. Если таблица появилась в структуре (т.е. это новая таблица), то: 
   - создается ее аудит;
   - выгружается ее snapshot.
3. Если таблица удалена, то удаляется и ее аудит. Данные, которые могли находится в аудите - отбрасываются, т.к. предполагается, 
   что данные из удаленной таблицы кто-то перенесет куда нужно при смене структуры, и это либо породит аудит 
   (если перенос в существующую таблицу), либо выгрузится snapshot-ом (если перенос в новую таблицу). 
   Иными словами - если не жалко удалить таблицу, то ее аудит не жалко тем более. 
4. Текущая "реальная" структура БД запоминается как "зафиксированная" структура.

Попытки фиксации происходят при получении специальной команды `SET_DB_STRUCT`. 

###### Замечание

При переименовании таблицы на сервер будет выгружена порция данных, которые и так там есть. - 

    Это скорее всего нормально, но ...

    ...если Abn переименовали в AbnNew, то на сервере после смены структуры уже будет куча данных в AbnNew,
    потом приедут реплики от snapshot, а в таблице перекодировок для AbnNew не будет данных о том, 
    что данные в реплике уже были зхагружались ранее (перекодировки останутся для Abn), 
    таким образом, данные в таблице AbnNew окажутся в итоге удвоенными.
    
    ...подумать   



### Переходные и временные состояния

Репликатор не обрабатывает свой аудит, а просто останавливается и ждет следующего запуска:
  - если "реальная" структура не совпадет с "зафиксированной".
  - если "реальная" структура не совпадет с "разрешенной".

Репликатор не применяет входящие реплики, а их применение откладывается до момента 
совпадения структуры БД на этой станции со структурой БД реплики:
  - если "реальная" структура не совпадет со структурой реплики. 
 
(Для репликатора реплики просто _другой_ структуры, репликатор не знает, новые они или старые, 
просто при нормальной работе все реплики _не нашей_ структуры - это реплики _новой_ структуры).

### Первичная инициализация рабочей станции

При начальной инициализации системы репликации текущая "реальная" структура БД сервера просто копируется как "разрешенная", 
после чего инициируется "фиксация структуры". 
Из-за этого первичная выгрузка всех данных на сервер (через механизм snapshot-ов) и инициализация аудита происходит само собой, 
за счет механизма "фиксация структуры" БД.

Значт есть команды: 
- `replication-drop` (очистить все, весь аудит и все фиксированные структуры) 
- `replication-db-struct` (фиксация смены структуры БД: посмотри, что там у тебя со структурой, устрани разницу).
