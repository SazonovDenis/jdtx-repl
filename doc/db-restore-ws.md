## Порядок действий при восстановлении БД рабочей станции из бэкапа или утере рабочих каталогов


### Анализ сбойной ситуации (признаки аварийной стуации)

Признаками восстановления из бэкапа является отставание расличных отметок и очередей друг от друга


#### Очереди реплик

Номер последней реплики в очереди отличается от номера последней реплики в рабочем каталоге.

Номер последней реплики в очереди отличается от номера реплики, последний раз отправленной на сервер или прочитанной с сервера.


#### Отметки

...


### Восстановление


#### Восстановление очередей до уровня перед сбоем

Входящая очередь восстанавливается из рабочего каталога до возраста последней реплики в нем.

Исходящая очередь также восстанавливается из рабочего каталога до возраста последней реплики в нем.

Если возраст входящей очереди меньше, чем возраст последней реплики, прочитанной с сервера до сбоя,
то входящая очередь дополнительно восстанавливается по данным с сервера.
При необходимости - с сервера заказывается повторная передача.

Если возраст исходящей очереди меньше, чем возраст последней реплики, отправленной на сервер до сбоя,
то исходящая очередь дополнительно восстанавливается по данным с сервера.
При необходимости - с сервера заказывается повторная передача.


#### Восстановление входящей очереди до последней собственной отправленной реплики

Поскольку очередь QueIn содержит непртиворечивый поток изменений, в котором также включены и все наши СОБСТВЕННЫЕ реплики,
то для восстановления данных достаточно применять только поток из QueIn, а не применять восстановленные реплики из QueOut.

С другой стороны, та QueOut, которую мы только что восстановили, может быть в очень старом состоянии, например,
используются справочники, которые ранее (до сбоя) поступили через QueIn, а в ремонтируемой базе их пока нет.
Поэтому наши собственные реплики нужно применять ТОЛЬКО через общую очередь.

Добиваемся того, чтобы в очереди QueIn оказались и все ранее отправленные наши СОБСТВЕННЫЕ реплики.


#### Восстановление данных по данным входящей очереди

После полного востановления очередей выполняется применение реплик из входящей очереди, от отмеченного использованния QueIn (noQueInUsed)
до последней реплики, имеющейся во входящей очереди.


#### Восстановление данных по данным исходящей очереди

После полного применения входящей очереди выясняется, нет ли в исходящей очереди QueOut таких реплик, короые мы еще НЕ ОТПРАВЛЯЛИ на сервер.

Если имеющаяся исходящая очередь старше реплик, ктороые мы еще НЕ ОТПРАВЛЯЛИ на сервер, значит исходящая очередь
содержит реплики, которые мы НЕ ПРИМЕНЯЛИ в рамках ремонта данных путем применения QueIn.
Чиним (восстанавливаем) данные на основе исходящей очереди QueOut.


#### Восстановление генераторов

После применения собственных реплик генераторы находятся в устаревшем состоянии.
Чиним генераторы.


#### Исправление отметок состояния

Если возраст "отправлено на сервер" меньше, чем фактический размер исходящей очереди - чиним отметку об отправке собственных реплик.

До какого возраста обработана очередь QueIn (noQueInUsed) - нет необходимости чинитиь, т.к. она уже сдвинута вызовом handleQueIn


#### Исправление отметок аудита

После ремонта данных применением собственных реплик из очередей QueIn и QueOut
аудит таблиц пуст, а отметка возраста аудита ("возраст age" для таблиц аудита) все ещё содержит устаревшее состояние.

После применения собственных реплик из очередей QueIn и QueOut отметка возраста ОБРАБОТАННОГО аудита
(до какого возраста аудит отмечен как выложенный в очередь QueOut) все ещё содержит устаревшее состояние.

Чиним отметку возраста аудита и отметку возраста обработанного аудита.


##### Отметка о начале ремонта

Убираем отметку "ремонт начат". После этого ремонт считается завершенным.
