## Восстановление из бэкапа базы данных рабочей станции

### Признаки восстановления из бэкапа 

Данная стратегия предполагает, что **_локальная очередь_** не повреждена.


##### Входящая очередь реплик 

Сравниваем

~~~
Сколько входящих реплик есть у нас "в закромах", т.е. в рабочем каталоге?

Сколько входящих получено у нас в "официальной" очереди
~~~


##### Исходящая очередь реплик 

Сравниваем:

~~~
Сколько исходящих реплик есть у нас "в закромах", т.е. в рабочем каталоге?
    
Cколько исходящих реплик есть у нас в очереди реплик (в базе)
    
Cколько исходящих реплик отметили как выложенные в очередь. 
Эта величина при работе репликатора - совпадает с базой, но после запуска ПРОЦЕДУРЫ РЕМОНТА recoverAfterBackupRestore - может отличаться. 
Является флагом, помогающим отследить НЕЗАВЕРШЕННОСТЬ РЕМОНТА.
~~~


##### Отправка исходящей очереди реплик 

Сравниваем

~~~
Сколько исходящих реплик фактически отправлено на сервер (спросим у почтового сервера)

Сколько исходящих реплик отмечено как отправленое на сервер
~~~

### Ремонт


##### Обнуляем отметку о пополнении исходящей очереди реплик. 

После этой отметки ремонт считается НАЧАТЫМ, но НЕ ЗАВЕРШЕННЫМ.


##### Чиним получение реплик.

Берем входящие реплики, которые мы пропустили. 
Кладем их в свою входящую очередь (потом они будут использованы штатным механизмом).
Запрос на сервер повторной отправки входящих реплик - НЕ НУЖНО - они у нас уже есть.

Применяем все входящие реплики штатным механизмом (handleQueIn). 
Важно их применить, т.к. среди входящих есть и НАШИ СОБСТВЕННЫЕ, но еще не примененные.


##### Восстанавливаем данные на основе собственного аудита.

Извлекаем из закромов все исходящие реплики, которых нет в исходящей очереди. 
Это данные, введенные ранее (до воставновления из бэкапа).  
Применяем у себя те реплики, которые еще не применяли из ВХОДЯЩЕЙ очереди QueIn.


Чиним генераторы. Это нужно после получения реплик (среди них были наши собственные) 
и применения собственных реплик из исходящей очереди.


##### Чиним отметку об отправке собственных реплик 

Если возраст "отправлено на сервер" меньше, чем фактический размер исходящей очереди, то обновляем состояние. 


##### Чиним отметку о пополнении исходящей очереди реплик.

После этой отметки ремонт считается завершенным.
