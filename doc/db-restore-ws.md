## Методика и алгоритм действия при восстановлении из бэкапа БД рабочей станции

### Признаки восстановления из бэкапа 

Данная стратегия предполагает, что **_локальная очередь_** не повреждена.


##### Входящая очередь реплик 

Сравниваем

~~~
Сколько входящих реплик есть у нас "в закромах", т.е. в рабочем каталоге?

Сколько входящих получено у нас в "официальной" очереди
~~~


##### Исходящая очередь реплик 

Сравниваем:

~~~
Сколько исходящих реплик есть у нас "в закромах", т.е. в рабочем каталоге?
    
Cколько исходящих реплик есть у нас в очереди реплик (в базе)
    
Cколько исходящих реплик отметили как выложенные в очередь. 
Эта величина при работе репликатора - совпадает с базой, но после запуска ПРОЦЕДУРЫ РЕМОНТА recoverAfterBackupRestore - может отличаться. 
Является флагом, помогающим отследить НЕЗАВЕРШЕННОСТЬ РЕМОНТА. 
todo - переписать, уже не так!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
~~~


##### Отправка исходящей очереди реплик 

Сравниваем

~~~
Сколько исходящих реплик фактически отправлено на сервер (спросим у почтового сервера)

Сколько исходящих реплик отмечено как отправленое на сервер
~~~

### Ремонт


##### Обнуляем отметку о пополнении исходящей очереди реплик. 

После этой отметки ремонт считается НАЧАТЫМ, но НЕ ЗАВЕРШЕННЫМ.


##### Восстанавливаем данные на основе входящих реплик.

###### Восстанавливаем входящую очередь 

Берем входящие реплики, от которых мы отстали. 
Кладем их в свою входящую очередь (потом они будут использованы штатным механизмом).
Запрос на сервер повторной отправки входящих реплик - НЕ НУЖНО - они у нас уже есть.

##### Восстанавливаем данные 

Применяем все входящие реплики штатным механизмом (handleQueIn). 
Важно их применить, т.к. среди входящих есть и НАШИ СОБСТВЕННЫЕ, но еще не примененные.


##### Восстанавливаем данные на основе собственного аудита.

Извлекаем из закромов все исходящие реплики, которых нет в "официальной" исходящей очереди. 
Это данные, сформированные ранее (до воставновления из бэкапа).  
Применяем у себя те реплики, которые еще не применяли из ВХОДЯЩЕЙ очереди QueIn.


##### Чиним отметку аудита 

Это нужно после применения реплик (входящих и собственного аудита), т.к. среди них были наши собственные, 
и после применения собственных реплик таблица возрастов для таблиц (z_z_age) все ещё содержит устаревшее состояние.


##### Чиним генераторы 
Это нужно после применения реплик (входящих и собственного аудита), т.к. среди них были наши собственные, 
и после применения собственных реплик генераторы находятся в устаревшем сосоянии.


##### Чиним отметку об отправке собственных реплик 

Если возраст "отправлено на сервер" меньше, чем фактический размер исходящей очереди, то обновляем состояние. 


##### Чиним отметку о пополнении исходящей очереди реплик.

После этой отметки ремонт считается завершенным.
